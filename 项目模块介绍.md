# LLMLight（LLMTSCS）项目模块功能介绍

## 一、项目简介

LLMLight（LLMTSCS）是一个将大语言模型（LLM）应用于城市交通信号控制（TSC）的创新项目。项目核心思想是利用LLM强大的泛化和推理能力，作为交通信号控制智能体，实现对复杂交通场景的高效决策。项目支持多种基线方法（传统、RL、LLM），并集成了仿真环境和可视化工具，具备良好的可扩展性和实验 reproducibility。

---

## 二、项目结构与主要模块

### 1. models/ —— 各类智能体模型

- **agent.py**  
  所有智能体的基类，定义了智能体的基本接口（如 choose_action）。

- **fixedtime_agent.py**  
  固定时序控制智能体，实现最简单的定时红绿灯切换策略。

- **maxpressure_agent.py / efficient_maxpressure_agent.py / advanced_maxpressure_agent.py**  
  最大压力法及其高效/高级变体，基于交通流压力进行决策。

- **mplight_agent.py / advanced_mplight_agent.py**  
  基于强化学习的MPLight模型及其高级版本，适用于多路口协同控制。

- **colight_agent.py / attendlight_agent.py**  
  基于图神经网络和注意力机制的多智能体RL模型，适合大规模路网。

- **presslight_one.py / simple_dqn_one.py**  
  其他强化学习方法的实现。

- **random_agent.py**  
  随机动作智能体，用于对比实验。

- **chatgpt.py**  
  集成OpenAI GPT-3.5/4等LLM的交通信号控制智能体，支持不同提示词（如常识、等待时间预测）。

- **network_agent.py**  
  网络型智能体的基类，支持神经网络的加载、保存、训练等操作。

---

### 2. utils/ —— 工具与流程支持

- **cityflow_env.py**  
  封装了CityFlow交通仿真环境，负责路口、车辆、信号灯等状态的管理与交互。

- **construct_sample.py**  
  用于从仿真数据中构建训练样本、状态、奖励等。

- **llm_aft_trainer.py**  
  LLM微调与策略改进相关流程，包括数据收集、训练、推理等。

- **pipeline.py / oneline.py**  
  管道式训练与单轮训练流程的实现，支持多模型、多轮次实验。

- **updater.py / generator.py**  
  用于样本生成、模型更新等辅助流程。

- **my_utils.py / utils.py**  
  常用工具函数，如json读写、状态转换、提示词生成等。

- **error.py**  
  自定义异常处理。

---

### 3. finetune/ —— LLM微调与策略改进

- **run_imitation_finetune.py**  
  基于模仿学习对LLM进行初步微调。

- **run_policy_refinement_data_collection.py**  
  收集策略改进所需的数据。

- **run_policy_refinement.py**  
  基于批评者的策略改进训练。

- **merge_lora.py**  
  LoRA适配器与基础模型的合并工具。

- **state_action_2_instructions.py**  
  状态-动作对转为LLM指令格式。

---

### 4. prompts/ —— LLM提示词

- **prompt_commonsense.json**  
  常识型交通专家提示词。

- **prompt_domain_knowledge.json**  
  数学与空间常识型交通专家提示词。

---

### 5. cityflow/ —— 交通仿真环境

- **frontend/**  
  可视化回放与前端页面。

- **tools/**  
  仿真数据转换、调试、生成等工具。

---

### 6. 运行脚本

- **run_advanced_colight.py / run_advanced_mplight.py / run_fixedtime.py / run_random.py 等**  
  各类智能体的实验主入口，指定数据集、交通流文件、实验参数等。

- **run_chatgpt.py**  
  运行基于ChatGPT的LLM智能体，支持不同提示词和模型版本。

- **run_open_LLM.py / run_open_LLM_with_vllm.py**  
  运行本地开源LLM或LightGPT模型，支持transformers和vllm两种推理方式。

---

## 三、数据集

- **data/**  
  包含济南、杭州、纽约等真实和合成交通流数据，支持不同规模和复杂度的实验。

---

## 四、LightGPT训练流程

1. **模仿学习微调**  
   使用run_imitation_finetune.py对LLM进行初步微调，模仿RL或专家策略。

2. **策略改进数据收集**  
   运行RL模型，收集LLM策略改进所需的数据。

3. **批评引导的策略改进**  
   通过run_policy_refinement.py进行批评者引导的策略优化。

4. **LoRA适配器合并**  
   使用merge_lora.py将LoRA适配器与基础模型合并，得到最终可部署模型。

---

## 五、使用方法简述

- 运行某个模型（如Advanced-MPLight）：
  ```bash
  python run_advanced_mplight.py --dataset hangzhou --traffic_file anon_4_4_hangzhou_real.json --proj_name TSCS
  ```
- 运行LLM智能体（如GPT-4）：
  ```bash
  python run_chatgpt.py --prompt Commonsense --dataset hangzhou --traffic_file anon_4_4_hangzhou_real.json --gpt_version gpt-4 --proj_name TSCS
  ```
- 运行本地开源LLM（如LightGPT）：
  ```bash
  python run_open_LLM.py --llm_model LLM_MODEL_NAME --llm_path LLM_PATH --dataset hangzhou --traffic_file anon_4_4_hangzhou_real.json --proj_name TSCS
  ```

---

## 六、总结

LLMLight项目通过模块化设计，将传统方法、强化学习和大语言模型有机结合，支持多种实验场景和模型扩展。你可以根据自己的研究兴趣，深入学习各个模块的实现细节，或直接运行脚本进行实验。

---

如需进一步了解某个模块的具体实现或代码细节，可随时告知！
